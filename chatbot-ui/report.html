<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title> Chatbot Report Downloader </title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="min-h-screen bg-[#1F1F38] flex flex-col items-center justify-center">
  <div class="w-full max-w-3xl mx-auto p-4 flex-grow">
    <div class="bg-[#2C2C6C] shadow-xl rounded-3xl px-8 py-10 relative">

      <!-- Logo + Logout (same row) -->
      <div class="flex items-center justify-center mb-6 relative">
        <div class="bg-white rounded-2xl px-6 py-3 shadow-md inline-flex items-center justify-center">
          <img
            src="https://raw.githubusercontent.com/da-sfspl/logo/1f152b53ba5e2d24ccabb3adf43ecc0e8b5438bf/Sampurna%20logo%20final%20without%20tagline%20png(2)%202%20(1).png"
            alt="Sampurna"
            class="h-10 md:h-12 object-contain"
          />
        </div>

        <!-- Logout button (right side of logo) -->
        <!-- Logout button (top-right, pink like Download Report) -->
<button
  type="button"
  onclick="logout()"
  class="absolute right-0 top-4 bg-pink-500 text-white text-sm font-semibold px-4 py-2 rounded-xl shadow-lg hover:bg-pink-600 transition"
  title="Logout"
>
  Logout
</button>

      </div>

      <h1 class="text-2xl md:text-3xl font-semibold text-center text-white">
        Chatbot Report Downloader
      </h1>
      <p class="mt-2 text-center text-slate-200">
        Select department, date range, and format to generate reports
      </p>

      <form id="reportForm" class="mt-8 space-y-6">

        <!-- Department Select (SINGLE) -->
        <div>
          <label class="block text-sm font-medium text-slate-100 mb-1">
            Select Department <span class="text-rose-300">*</span>
          </label>

          <div class="relative" id="deptDropdownWrapper">
            <button type="button" id="deptDropdownButton"
              class="w-full flex justify-between items-center border border-slate-300 rounded-xl px-3 py-2.5 bg-white text-sm text-slate-700 shadow-sm">
              <span id="deptSelectedText" class="truncate text-left text-slate-400">
                Select department...
              </span>
              <svg class="w-4 h-4 text-slate-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M19 9l-7 7-7-7"/>
              </svg>
            </button>

            <div id="deptDropdown"
              class="hidden absolute z-20 mt-1 w-full bg-white border border-slate-200 rounded-xl shadow-lg">

              <div class="px-3 py-2 border-b border-slate-100 flex justify-end">
                <button type="button" id="deptClearAll" class="text-xs font-medium text-slate-500">
                  Clear
                </button>
              </div>

              <div class="py-1 text-sm">
                <label class="flex items-center px-3 py-2 hover:bg-slate-50 cursor-pointer">
                  <span class="w-2 h-2 rounded-full bg-blue-500 mr-2"></span>
                  <input type="radio" name="department" class="dept-option mr-2" value="IT" />
                  <span>IT Department</span>
                </label>

                <label class="flex items-center px-3 py-2 hover:bg-slate-50 cursor-pointer">
                  <span class="w-2 h-2 rounded-full bg-green-500 mr-2"></span>
                  <input type="radio" name="department" class="dept-option mr-2" value="HR" />
                  <span>HR Department</span>
                </label>

                <label class="flex items-center px-3 py-2 hover:bg-slate-50 cursor-pointer">
                  <span class="w-2 h-2 rounded-full bg-purple-500 mr-2"></span>
                  <input type="radio" name="department" class="dept-option mr-2" value="LAVANYA" />
                  <span>LAVANYA</span>
                </label>
				
			    <label class="flex items-center px-3 py-2 hover:bg-slate-50 cursor-pointer">
                  <span class="w-2 h-2 rounded-full bg-amber-500 mr-2"></span>
                  <input type="radio" name="department" class="dept-option mr-2" value="ACCOUNTS" />
                 <span>Accounts</span>
               </label>

              </div>
            </div>
          </div>

          <p id="deptError" class="mt-1 text-xs text-rose-300 hidden">
            Please select a department.
          </p>
        </div>

        <!-- Date Range -->
        <div>
          <label class="block text-sm font-medium text-slate-100 mb-1">
            Date Range <span class="text-rose-300">*</span>
          </label>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
            <div>
              <span class="block text-xs text-slate-300 mb-0.5">From Date</span>
              <input type="date" id="fromDate"
                class="w-full border border-slate-300 rounded-xl px-3 py-2.5 text-sm shadow-sm bg-white" />
            </div>
            <div>
              <span class="block text-xs text-slate-300 mb-0.5">To Date</span>
              <input type="date" id="toDate"
                class="w-full border border-slate-300 rounded-xl px-3 py-2.5 text-sm shadow-sm bg-white" />
            </div>
          </div>
          <p id="dateError" class="mt-1 text-xs text-rose-300 hidden">
            Please select a valid date range.
          </p>
        </div>

        <!-- CSV Format -->
        <div>
          <label class="block text-sm font-medium text-slate-100 mb-1">
            File Format <span class="text-rose-300">*</span>
          </label>

          <label class="border border-pink-500 bg-pink-50 rounded-2xl px-4 py-3 flex flex-col shadow-sm">
            <span class="font-semibold text-sm text-slate-900">CSV</span>
            <p class="text-xs text-slate-500">.csv – Plain text data format</p>
          </label>
        </div>

        <!-- Submit -->
        <button type="submit" id="downloadBtn"
          class="w-full flex items-center justify-center gap-2 bg-pink-500 text-white font-medium px-4 py-3 rounded-2xl shadow-lg hover:bg-pink-600">
          <span id="downloadBtnIcon">⬇️</span>
          <span id="downloadBtnText">Download Report</span>
        </button>

      </form>
    </div>
  </div>

  <!-- FOOTER -->
  <footer class="w-full bg-[#4DB5FF] py-2">
    <p class="text-xs text-center text-[#1F1F38] font-semibold">
      Made With ❤️ From Sampurna IT Team
    </p>
  </footer>

<script>
  const N8N_WEBHOOK_URL = "https://n8n.srv896137.hstgr.cloud/webhook/Report_data";

  // OPTIONAL (recommended for demo): block access if not logged in
  // Use the same key you set in login page after auth success.
  // Example: localStorage.setItem("auth", "true")
  //
  // (function routeGuard(){
  //   const isAuth = localStorage.getItem("auth") === "true";
  //   if(!isAuth) window.location.href = "index.html";
  // })();

  function logout() {
    // Clear any auth markers you used in login page
    localStorage.removeItem("auth");
    localStorage.removeItem("token");
    localStorage.removeItem("user");
    sessionStorage.clear(); // safe nuke for session state
    window.location.href = "index.html";
  }

  const deptBtn = document.getElementById("deptDropdownButton");
  const deptDropdown = document.getElementById("deptDropdown");
  const deptSelectedText = document.getElementById("deptSelectedText");
  const deptOptions = document.querySelectorAll(".dept-option");
  const clearAllBtn = document.getElementById("deptClearAll");
  const deptError = document.getElementById("deptError");

  let selectedDepartment = "";

  deptBtn.addEventListener("click", () => {
    deptDropdown.classList.toggle("hidden");
  });

  document.addEventListener("click", (e) => {
    if (!document.getElementById("deptDropdownWrapper").contains(e.target)) {
      deptDropdown.classList.add("hidden");
    }
  });

  deptOptions.forEach(opt => {
    opt.addEventListener("change", () => {
      selectedDepartment = opt.value;
      deptSelectedText.textContent = opt.parentElement.innerText.trim();
      deptSelectedText.classList.remove("text-slate-400");
      deptDropdown.classList.add("hidden");
    });
  });

  clearAllBtn.addEventListener("click", () => {
    deptOptions.forEach(o => o.checked = false);
    selectedDepartment = "";
    deptSelectedText.textContent = "Select department...";
    deptSelectedText.classList.add("text-slate-400");
  });

  document.getElementById("reportForm").addEventListener("submit", async (e) => {
    e.preventDefault();

    const fromDate = document.getElementById("fromDate").value;
    const toDate = document.getElementById("toDate").value;

    if (!selectedDepartment) {
      deptError.classList.remove("hidden");
      return;
    } else {
      deptError.classList.add("hidden");
    }

    if (!fromDate || !toDate || new Date(fromDate) > new Date(toDate)) {
      document.getElementById("dateError").classList.remove("hidden");
      return;
    } else {
      document.getElementById("dateError").classList.add("hidden");
    }

    const params = new URLSearchParams({
      departments: selectedDepartment,
      from_date: fromDate,
      to_date: toDate,
      format: "csv"
    });

    const url = `${N8N_WEBHOOK_URL}?${params.toString()}`;

    const res = await fetch(url);
    const blob = await res.blob();

    const link = document.createElement("a");
    link.href = URL.createObjectURL(blob);
    link.download = `report_${new Date().toISOString().slice(0,10)}.csv`;
    link.click();
  });
</script>
</body>
</html>
